kind: pipeline
name: deploy main
trigger:
  branch: [main]
  event: [push]

steps:
  - name: deploy main
    image: python:3.6
    environment:
      SSH_KEY:
        from_secret: PRIVATE_KEY
    commands:
      - pip install fabric
      - mkdir -p $HOME/.ssh/
      - echo "$SSH_KEY" > $HOME/.ssh/id_rsa
      - chmod 600 $HOME/.ssh/id_rsa
      - fab production deploy
    when:
      branch:
        - main
      event:
        exclude:
          - pull_request

  - name: chats alert
    image: peloton/drone-google-chat
    settings:
      webhook: https://chat.googleapis.com/v1/spaces/AAAAwveY2ZM
      key: AIzaSyDdI0hCZtE6vySjMm-WEfRq3CPzqKqqsHI
      token: SCR71sc-yLpa-WkC9Mph0t01rzEyjhOKadZJuTUc4yw%3D
      link_names: true
      template: >
        {{#success build.status}}
          {{ repo.name }} deploy #{{build.number}} on chat.cloudez.io done with {{ since build.started }}.
        {{else}}
          <users/all> {{ repo.name }} deploy #{{build.number}} on chat.cloudez.io failed.
        {{/success}}
    when:
      branch:
        - main
      status: [success, failure]
